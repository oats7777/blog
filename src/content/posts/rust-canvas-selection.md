---
title: 'ê·¸ë¦¼íŒì— ì„ íƒ ë„êµ¬ ë§Œë“¤ê¸°: íˆíŠ¸ í…ŒìŠ¤íŠ¸ë¶€í„° ëŸ¬ë²„ë°´ë“œê¹Œì§€'
description: 'Retained Mode ë°ì´í„° ëª¨ë¸ ìœ„ì— ì„ íƒ, ì´ë™, ë³µì‚¬, ë¶™ì—¬ë„£ê¸°, Undo/Redoë¥¼ êµ¬í˜„í•˜ë©° ë°°ìš´ ê²ƒë“¤'
date: '2026-02-12'
order: 2
category: 'WebAssembly'
tags: ['Rust', 'WebAssembly', 'Canvas API', 'Hit Testing']
readTime: '15ë¶„ ì½ê¸°'
draft: false
---

## ë“¤ì–´ê°€ë©°

[ì´ì „ ê¸€](/posts/rust-canvas-wasm)ì—ì„œ Immediate Mode â†’ Retained Mode ì „í™˜ê¹Œì§€ ë‹¤ë¤˜ë‹¤. ëª¨ë“  ìŠ¤íŠ¸ë¡œí¬ë¥¼ `Vec<Stroke>`ì— ì €ì¥í•˜ê³  ë§¤ í”„ë ˆì„ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” êµ¬ì¡°ë¡œ ë°”ê¾¼ ê²ƒì´ë‹¤.

ê·¸ë•Œ íšŒê³ ì—ì„œ ì´ë ‡ê²Œ ì¼ë‹¤:

> Retained ë°ì´í„° ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ Undo/Redo, ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°, ë ˆì´ì–´ ë“±ì˜ í™•ì¥ì´ ê°€ëŠ¥í•˜ë‹¤.

ë§ë§Œ í•˜ê³  ë„˜ì–´ê°”ëŠ”ë°, ì´ë²ˆì— ì‹¤ì œë¡œ í™•ì¥í•´ë´¤ë‹¤. **ì„ íƒ, ì´ë™, ë³µì‚¬, ë¶™ì—¬ë„£ê¸°.** ê·¸ë¦¬ê³  ì´ ê³¼ì •ì—ì„œ "ë°ì´í„°ë¥¼ ë³´ì¡´í•˜ê³  ìˆë‹¤"ëŠ” ê²ƒì´ êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ì˜ë¯¸ì¸ì§€ ì²´ê°í–ˆë‹¤.

---

## 1. íˆíŠ¸ í…ŒìŠ¤íŠ¸ â€” "ì´ í´ë¦­ì´ ì–´ëŠ ì„  ìœ„ì¸ê°€?"

ì„ íƒ ë„êµ¬ì˜ ì²« ë²ˆì§¸ ë¬¸ì œ: ì‚¬ìš©ìê°€ ìº”ë²„ìŠ¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ, ê·¸ ì¢Œí‘œê°€ ì–´ë–¤ ìŠ¤íŠ¸ë¡œí¬ ìœ„ì— ìˆëŠ”ì§€ ì•Œì•„ë‚´ì•¼ í•œë‹¤.

### ë°”ìš´ë”© ë°•ìŠ¤ë¡œëŠ” ë¶€ì¡±í•˜ë‹¤

ê°€ì¥ ë‹¨ìˆœí•œ ì ‘ê·¼ì€ ê° ìŠ¤íŠ¸ë¡œí¬ì˜ ë°”ìš´ë”© ë°•ìŠ¤(ìµœì†Œ/ìµœëŒ€ ì¢Œí‘œë¡œ ë§Œë“  ì‚¬ê°í˜•)ë¥¼ ê²€ì‚¬í•˜ëŠ” ê²ƒì´ë‹¤. í•˜ì§€ë§Œ ììœ ê³¡ì„ ì—ëŠ” ë§ì§€ ì•ŠëŠ”ë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  â•±   â”‚ â† ë°”ìš´ë”© ë°•ìŠ¤ ì•ˆì´ì§€ë§Œ
â”‚ âœ•              â•±    â”‚    ì„ ê³¼ëŠ” í•œì°¸ ë–¨ì–´ì§„ ê³³
â”‚              â•±      â”‚
â”‚            â•±        â”‚
â”‚          â•±          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ëŒ€ê°ì„ ìœ¼ë¡œ ê¸¸ê²Œ ë»—ëŠ” ì„ ì˜ ë°”ìš´ë”© ë°•ìŠ¤ëŠ” ëŒ€ë¶€ë¶„ì´ ë¹ˆ ê³µê°„ì´ë‹¤. ì—¬ê¸°ë¥¼ í´ë¦­í•´ë„ "ì„ íƒë¨"ìœ¼ë¡œ íŒì •í•˜ë©´ UXê°€ ë‚˜ì˜ë‹¤.

### ì ì—ì„œ ì„ ë¶„ê¹Œì§€ì˜ ê±°ë¦¬ ê³„ì‚°

ê·¸ë˜ì„œ **ì (í´ë¦­ ì¢Œí‘œ)ì—ì„œ ì„ ë¶„(ìŠ¤íŠ¸ë¡œí¬ì˜ ê° êµ¬ê°„)ê¹Œì§€ì˜ ìµœë‹¨ ê±°ë¦¬**ë¥¼ ìˆ˜í•™ì ìœ¼ë¡œ ê³„ì‚°í•˜ëŠ” ë°©ì‹ì„ íƒí–ˆë‹¤.

ì†”ì§íˆ ê³ ë°±í•˜ë©´, "ë²¡í„° íˆ¬ì˜ìœ¼ë¡œ ì ê³¼ ì„ ë¶„ ì‚¬ì´ ìµœë‹¨ ê±°ë¦¬ë¥¼ êµ¬í•˜ë©´ ëœë‹¤"ëŠ” ê±´ AIí•œí…Œ ë¬¼ì–´ë´ì„œ ì•Œì•˜ë‹¤. ê³ ë“±í•™êµ ìˆ˜í•™ ì‹œê°„ì— ìëŠë¼ ë‚´ì (dot product)ì´ ë­”ì§€ ì œëŒ€ë¡œ ë“¤ì€ ì ì´ ì—†ë‹¤. ìˆ˜í•™ì€ ëª» ë“¤ì–´ë„ AIëŠ” ê¸°ì–µí•˜ë”ë¼.

í•µì‹¬ì€ ë²¡í„° íˆ¬ì˜(projection)ì´ë‹¤:

```rust
fn point_to_segment_distance(p: &Point, a: &Point, b: &Point) -> f64 {
    let dx = b.x - a.x;
    let dy = b.y - a.y;
    let len_sq = dx * dx + dy * dy;

    if len_sq == 0.0 {
        // ì„ ë¶„ ê¸¸ì´ê°€ 0 (ì )
        let ex = p.x - a.x;
        let ey = p.y - a.y;
        return (ex * ex + ey * ey).sqrt();
    }

    // Pë¥¼ ì„ ë¶„ AB ìœ„ì— íˆ¬ì˜, [0, 1] ë²”ìœ„ë¡œ í´ë¨í”„
    let t = ((p.x - a.x) * dx + (p.y - a.y) * dy) / len_sq;
    let t = t.clamp(0.0, 1.0);

    // íˆ¬ì˜ì ê³¼ P ì‚¬ì´ì˜ ê±°ë¦¬
    let proj_x = a.x + t * dx;
    let proj_y = a.y + t * dy;
    let ex = p.x - proj_x;
    let ey = p.y - proj_y;
    (ex * ex + ey * ey).sqrt()
}
```

`t`ê°€ 0ì´ë©´ ì  Aì— ê°€ì¥ ê°€ê¹ê³ , 1ì´ë©´ ì  Bì— ê°€ì¥ ê°€ê¹ê³ , 0.5ë©´ ì„ ë¶„ ì¤‘ê°„ì´ë‹¤. `clamp(0.0, 1.0)`ìœ¼ë¡œ ì„ ë¶„ ë²”ìœ„ ë°”ê¹¥ìœ¼ë¡œ ë²—ì–´ë‚˜ì§€ ì•Šê²Œ í•œë‹¤.

ìŠ¤íŠ¸ë¡œí¬ì˜ ëª¨ë“  ì—°ì† ì„ ë¶„ ìŒì— ëŒ€í•´ ì´ ê³„ì‚°ì„ ìˆ˜í–‰í•˜ê³ , í•˜ë‚˜ë¼ë„ í—ˆìš© ì˜¤ì°¨ ì´ë‚´ë©´ íˆíŠ¸ë¡œ íŒì •í•œë‹¤:

```rust
pub(crate) fn hit_test_stroke(stroke: &Stroke, x: f64, y: f64) -> bool {
    let threshold = (stroke.width / 2.0 + 4.0).max(8.0);
    let p = Point { x, y };

    for i in 0..stroke.points.len().saturating_sub(1) {
        let dist = point_to_segment_distance(
            &p, &stroke.points[i], &stroke.points[i + 1]
        );
        if dist <= threshold {
            return true;
        }
    }
    false
}
```

í—ˆìš© ì˜¤ì°¨ë¥¼ `max(width/2 + 4, 8)px`ë¡œ ì„¤ì •í•œ ì´ìœ : ê°€ëŠë‹¤ë€ ì„ (1px)ë„ ìµœì†Œ 8pxì˜ íˆíŠ¸ ì˜ì—­ì„ ê°€ì ¸ì„œ í„°ì¹˜í•˜ê¸° ì‰½ê³ , êµµì€ ì„ ì€ ì‹œê°ì  ì˜ì—­ê³¼ íˆíŠ¸ ì˜ì—­ì´ ìì—°ìŠ¤ëŸ½ê²Œ ì¼ì¹˜í•œë‹¤.

---

## 2. ì„ íƒ ì‹œìŠ¤í…œ ì„¤ê³„

### ìƒíƒœ ê´€ë¦¬: `HashSet<u32>`

ì„ íƒ ìƒíƒœëŠ” `HashSet<u32>`ë¡œ ê´€ë¦¬í•œë‹¤. ìŠ¤íŠ¸ë¡œí¬ IDì˜ ì§‘í•©ì´ë‹¤.

```rust
pub(crate) selected_ids: HashSet<u32>,
```

ì´ ìë£Œêµ¬ì¡°ë¥¼ ì„ íƒí•œ ì´ìœ :
- **O(1) ì‚½ì…/ì‚­ì œ/ì¡°íšŒ**: "ì´ ìŠ¤íŠ¸ë¡œí¬ê°€ ì„ íƒë˜ì–´ ìˆëŠ”ê°€?" í™•ì¸ì´ ìƒìˆ˜ ì‹œê°„
- **ìì—°ìŠ¤ëŸ¬ìš´ ë‹¤ì¤‘ ì„ íƒ**: Shift+í´ë¦­ìœ¼ë¡œ í† ê¸€í•˜ë©´ ëœë‹¤
- **ë Œë”ë§ ì‹œ ì‚¬ìš©**: ë§¤ í”„ë ˆì„ë§ˆë‹¤ ì „ì²´ ìŠ¤íŠ¸ë¡œí¬ë¥¼ ìˆœíšŒí•˜ë©´ì„œ ì„ íƒ ì—¬ë¶€ë¥¼ í™•ì¸í•´ì•¼ í•˜ë¯€ë¡œ ë¹ ë¥¸ ì¡°íšŒê°€ ì¤‘ìš”

### í´ë¦­ ì„ íƒê³¼ Shift í† ê¸€

ì„ íƒ ë„êµ¬ ëª¨ë“œì—ì„œ í´ë¦­í•˜ë©´ `try_select_at`ì´ í˜¸ì¶œëœë‹¤:

```rust
pub fn try_select_at(&mut self, x: f64, y: f64, shift: bool) -> bool {
    // ì—­ìˆœ íƒìƒ‰: ë‚˜ì¤‘ì— ê·¸ë¦° ìŠ¤íŠ¸ë¡œí¬ê°€ ìœ„ì— ë³´ì´ë¯€ë¡œ ë¨¼ì € ê²€ì‚¬
    let mut hit_id: Option<u32> = None;
    for stroke in self.strokes.iter().rev() {
        if hit_test_stroke(stroke, x, y) {
            hit_id = Some(stroke.id);
            break;
        }
    }

    match hit_id {
        Some(id) => {
            if shift {
                // Shift+í´ë¦­: í† ê¸€ (ì´ë¯¸ ì„ íƒëìœ¼ë©´ í•´ì œ, ì•„ë‹ˆë©´ ì¶”ê°€)
                if !self.selected_ids.remove(&id) {
                    self.selected_ids.insert(id);
                }
            } else {
                // ì¼ë°˜ í´ë¦­: ë‹¨ì¼ ì„ íƒ
                self.selected_ids.clear();
                self.selected_ids.insert(id);
            }
            true
        }
        None => {
            if !shift { self.selected_ids.clear(); }
            false
        }
    }
}
```

`iter().rev()`ë¡œ ì—­ìˆœ íƒìƒ‰í•˜ëŠ” ì´ìœ : ë‚˜ì¤‘ì— ê·¸ë¦° ìŠ¤íŠ¸ë¡œí¬ê°€ í™”ë©´ì—ì„œ ìœ„ì— ë³´ì¸ë‹¤. ê²¹ì³ ìˆì„ ë•Œ ì‚¬ìš©ìê°€ ë³´ëŠ” ê²ƒê³¼ ì„ íƒë˜ëŠ” ê²ƒì´ ì¼ì¹˜í•´ì•¼ í•œë‹¤.

---

## 3. ëŸ¬ë²„ë°´ë“œ â€” ë“œë˜ê·¸ë¡œ ì˜ì—­ ì„ íƒ

í´ë¦­ ì„ íƒë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë‹¤. Photoshop, Figma ë“± ëª¨ë“  ì—ë””í„°ì— ìˆëŠ” ê¸°ëŠ¥â€”**ë¹ˆ ì˜ì—­ì„ ë“œë˜ê·¸í•´ì„œ ì‚¬ê°í˜•ì„ ê·¸ë¦¬ë©´ ê·¸ ì•ˆì˜ ìš”ì†Œê°€ ì „ë¶€ ì„ íƒ**ë˜ëŠ” ê²ƒ. ì´ê±¸ ëŸ¬ë²„ë°´ë“œ(rubber band) ì„ íƒì´ë¼ê³  í•œë‹¤.

### ë™ì‘ íë¦„

```
ë¹ˆ ì˜ì—­ mousedown â†’ ëŸ¬ë²„ë°´ë“œ ì‹œì‘ (ì‹œì‘ì  ì €ì¥)
mousemove â†’ ë°˜íˆ¬ëª… ì‚¬ê°í˜• ì‹¤ì‹œê°„ ë Œë”ë§
mouseup â†’ ì˜ì—­ ë‚´ ìŠ¤íŠ¸ë¡œí¬ ì¼ê´„ ì„ íƒ
```

### ì˜ì—­-ìŠ¤íŠ¸ë¡œí¬ êµì°¨ íŒì •

ëŸ¬ë²„ë°´ë“œê°€ ëë‚˜ë©´, ë“œë˜ê·¸í•œ ì‚¬ê°í˜•ê³¼ ê° ìŠ¤íŠ¸ë¡œí¬ì˜ ë°”ìš´ë”© ë°•ìŠ¤ê°€ ê²¹ì¹˜ëŠ”ì§€ ê²€ì‚¬í•œë‹¤. ì—¬ê¸°ì„œëŠ” íˆíŠ¸ í…ŒìŠ¤íŠ¸ì™€ ë‹¬ë¦¬ **ë°”ìš´ë”© ë°•ìŠ¤ êµì°¨(AABB ì¶©ëŒ ê²€ì‚¬)**ê°€ ì í•©í•˜ë‹¤â€”ì˜ì—­ ì„ íƒì€ "ëŒ€ëµ ì´ ë²”ìœ„ ì•ˆì— ìˆëŠ” ê²ƒ"ì„ ì„ íƒí•˜ëŠ” ê²ƒì´ë¯€ë¡œ ì •ë°€ë„ë³´ë‹¤ ì§ê´€ì„±ì´ ì¤‘ìš”í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

```rust
impl BoundingBox {
    pub fn intersects(&self, other: &BoundingBox) -> bool {
        self.min_x <= other.max_x
            && self.max_x >= other.min_x
            && self.min_y <= other.max_y
            && self.max_y >= other.min_y
    }
}
```

ë„¤ ê°€ì§€ ì¡°ê±´ì´ ëª¨ë‘ ì°¸ì´ë©´ ë‘ ì‚¬ê°í˜•ì´ ê²¹ì¹œë‹¤. í•˜ë‚˜ë¼ë„ ê±°ì§“ì´ë©´ ë–¨ì–´ì ¸ ìˆë‹¤.

### ì‹œê°ì  í”¼ë“œë°±

ë“œë˜ê·¸ ì¤‘ì—ëŠ” ë°˜íˆ¬ëª… íŒŒë€ìƒ‰ ì‚¬ê°í˜•ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ê·¸ë ¤ì§„ë‹¤:

```rust
pub(crate) fn draw_rubber_band(&self) {
    if !self.is_rubber_band { return; }

    let x = self.rubber_band_start_x.min(self.rubber_band_end_x);
    let y = self.rubber_band_start_y.min(self.rubber_band_end_y);
    let w = (self.rubber_band_end_x - self.rubber_band_start_x).abs();
    let h = (self.rubber_band_end_y - self.rubber_band_start_y).abs();

    self.ctx.save();
    // ë°˜íˆ¬ëª… íŒŒë€ ë°°ê²½
    self.ctx.set_fill_style_str("rgba(59, 130, 246, 0.1)");
    self.ctx.fill_rect(x, y, w, h);
    // íŒŒë€ ì ì„  í…Œë‘ë¦¬
    // ...
    self.ctx.restore();
}
```

`min`/`abs`ë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ : ì‚¬ìš©ìê°€ ì˜¤ë¥¸ìª½ ì•„ë˜ì—ì„œ ì™¼ìª½ ìœ„ë¡œ ë“œë˜ê·¸í•  ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ì‹œì‘ì ì´ í•­ìƒ ì¢Œìƒë‹¨ì´ ì•„ë‹ ìˆ˜ ìˆë‹¤.

---

## 4. ì´ë™ â€” ì¢Œí‘œì˜ ë§ì…ˆ

ì„ íƒëœ ìŠ¤íŠ¸ë¡œí¬ë¥¼ ë“œë˜ê·¸í•˜ë©´ ì´ë™í•´ì•¼ í•œë‹¤. Retained Modeì—ì„œ ì´ë™ì€ ë†€ë¼ìš¸ ì •ë„ë¡œ ë‹¨ìˆœí•˜ë‹¤:

```rust
pub fn translate(&mut self, dx: f64, dy: f64) {
    for p in &mut self.points {
        p.x += dx;
        p.y += dy;
    }
}
```

ëª¨ë“  ì ì— `(dx, dy)`ë¥¼ ë”í•˜ë©´ ëì´ë‹¤. `render()`ê°€ ë§¤ í”„ë ˆì„ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ë‹ˆê¹Œ, ë°ì´í„°ë§Œ ë°”ê¾¸ë©´ í™”ë©´ì´ ë”°ë¼ì˜¨ë‹¤.

ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ìª½ì—ì„œëŠ” ë§¤ `mousemove`ë§ˆë‹¤ ì´ì „ ì¢Œí‘œì™€ì˜ ì°¨ì´(delta)ë¥¼ ê³„ì‚°í•´ì„œ ë„˜ê¸´ë‹¤:

```rust
pub fn move_selected(&mut self, x: f64, y: f64) {
    if !self.is_moving { return; }
    let dx = x - self.move_start_x;
    let dy = y - self.move_start_y;

    for stroke in &mut self.strokes {
        if self.selected_ids.contains(&stroke.id) {
            stroke.translate(dx, dy);
        }
    }

    self.move_total_dx += dx;
    self.move_total_dy += dy;
    self.move_start_x = x;
    self.move_start_y = y;
    self.render();
}
```

`move_start`ë¥¼ ë§¤ë²ˆ ê°±ì‹ í•˜ëŠ” ì´ìœ : ì ˆëŒ€ ìœ„ì¹˜ê°€ ì•„ë‹ˆë¼ í”„ë ˆì„ ê°„ ìƒëŒ€ ì´ë™ëŸ‰ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì´ë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë“œë˜ê·¸ ì¤‘ ìŠ¤íŠ¸ë¡œí¬ê°€ ë§ˆìš°ìŠ¤ë¥¼ ì •í™•íˆ ë”°ë¼ì˜¨ë‹¤.

`selected_ids`ê°€ `HashSet`ì´ë¯€ë¡œ `contains`ê°€ O(1)ì´ë‹¤. `move_total_dx/dy`ëŠ” í”„ë ˆì„ë§ˆë‹¤ ëˆ„ì ë˜ì–´ undo ì‹œ ì „ì²´ ì´ë™ëŸ‰ì„ í•œ ë²ˆì— ë˜ëŒë¦¬ëŠ” ë° ì“°ì¸ë‹¤.

---

## 5. ë³µì‚¬ì™€ ë¶™ì—¬ë„£ê¸° â€” `clone()`ì˜ í˜

### ë‚´ë¶€ í´ë¦½ë³´ë“œ

í´ë¦½ë³´ë“œëŠ” Rust ë‚´ë¶€ `Vec<Stroke>`ë¡œ êµ¬í˜„í–ˆë‹¤. ë¸Œë¼ìš°ì € Clipboard APIëŠ” í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ìš©ì´ì§€, ìš°ë¦¬ ìŠ¤íŠ¸ë¡œí¬ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ê³³ì´ ì—†ë‹¤.

```rust
pub fn copy_selected(&mut self) {
    self.clipboard.clear();
    for stroke in &self.strokes {
        if self.selected_ids.contains(&stroke.id) {
            self.clipboard.push(stroke.clone());
        }
    }
}
```

`Stroke`ê°€ `#[derive(Clone)]`ì´ë‹ˆê¹Œ `clone()` í•œ ì¤„ì´ë©´ ê¹Šì€ ë³µì‚¬ê°€ ëë‚œë‹¤. ì  ë°°ì—´ê¹Œì§€ ì „ë¶€ ë³µì‚¬ëœë‹¤.

### ë¶™ì—¬ë„£ê¸°: ìƒˆ ID + ì˜¤í”„ì…‹

```rust
pub fn paste(&mut self) {
    if self.clipboard.is_empty() { return; }

    let offset = 20.0;
    self.selected_ids.clear();

    for original in &self.clipboard.clone() {
        let mut cloned = original.clone();
        cloned.id = self.next_id;        // ìƒˆ ID ë¶€ì—¬
        self.next_id += 1;
        cloned.translate(offset, offset); // 20px ì˜¤ë¥¸ìª½ ì•„ë˜ë¡œ
        self.selected_ids.insert(cloned.id);
        self.strokes.push(cloned);
    }

    // í´ë¦½ë³´ë“œë¥¼ ë°©ê¸ˆ ë¶™ì—¬ë„£ì€ ê²ƒìœ¼ë¡œ ê°±ì‹  â†’ ë°˜ë³µ ë¶™ì—¬ë„£ê¸° ì‹œ ì˜¤í”„ì…‹ ëˆ„ì 
    self.clipboard = self.strokes.iter()
        .filter(|s| self.selected_ids.contains(&s.id))
        .cloned()
        .collect();

    self.render();
}
```

ì„¤ê³„ í¬ì¸íŠ¸:
- **ìƒˆ ID ë¶€ì—¬**: `next_id` ì¹´ìš´í„°ë¡œ ê³ ìœ ì„± ë³´ì¥. ê°™ì€ IDê°€ ë‘ ê°œ ìˆìœ¼ë©´ ì„ íƒ/ì‚­ì œê°€ ê¼¬ì¸ë‹¤
- **20px ì˜¤í”„ì…‹**: ì›ë³¸ê³¼ ì •í™•íˆ ê²¹ì¹˜ë©´ ë¶™ì—¬ë„£ì€ ê±´ì§€ ì•Œ ìˆ˜ ì—†ë‹¤
- **í´ë¦½ë³´ë“œ ê°±ì‹ **: Ctrl+Vë¥¼ ì—°ì†ìœ¼ë¡œ ëˆ„ë¥´ë©´ 20px, 40px, 60px... ê³„ë‹¨ì‹ìœ¼ë¡œ ë¶™ì—¬ë„£ì–´ì§„ë‹¤

---

## 6. ë Œë”ë§ íŒŒì´í”„ë¼ì¸ í™•ì¥

ê¸°ì¡´ ë Œë”ë§ íŒŒì´í”„ë¼ì¸ì— ì„ íƒ ê´€ë ¨ ë ˆì´ì–´ê°€ ë‘ ê°œ ì¶”ê°€ëë‹¤:

```
render()
â”œâ”€â”€ clear_canvas()          â† í° ë°°ê²½
â”œâ”€â”€ draw all strokes        â† ì €ì¥ëœ ëª¨ë“  ìŠ¤íŠ¸ë¡œí¬
â”œâ”€â”€ draw current stroke     â† ê·¸ë¦¬ëŠ” ì¤‘ì¸ ìŠ¤íŠ¸ë¡œí¬
â”œâ”€â”€ draw_selection_highlight()  â† ğŸ†• ì„ íƒëœ ìŠ¤íŠ¸ë¡œí¬ ë°”ìš´ë”© ë°•ìŠ¤
â”œâ”€â”€ draw_rubber_band()          â† ğŸ†• ë“œë˜ê·¸ ì˜ì—­ ì‚¬ê°í˜•
â””â”€â”€ draw_cursor_preview()   â† ì»¤ì„œ ë¯¸ë¦¬ë³´ê¸°
```

ëª¨ë“  ë Œë”ë§ ë ˆì´ì–´ê°€ `ctx.save()`/`ctx.restore()`ë¡œ ê²©ë¦¬ë˜ì–´ ìˆì–´ì„œ, ê° ë ˆì´ì–´ì˜ ì„  ìŠ¤íƒ€ì¼(ì ì„ , ìƒ‰ìƒ, êµµê¸°)ì´ ë‹¤ë¥¸ ë ˆì´ì–´ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.

---

## 7. JS ì´ë²¤íŠ¸ ë¼ìš°íŒ… â€” í•˜ë‚˜ì˜ ìº”ë²„ìŠ¤, ì„¸ ê°€ì§€ í–‰ë™

ê°™ì€ `mousedown` ì´ë²¤íŠ¸ê°€ ë„êµ¬ ëª¨ë“œì— ë”°ë¼ ì™„ì „íˆ ë‹¤ë¥¸ ë™ì‘ì„ í•´ì•¼ í•œë‹¤:

```typescript
canvasEl.addEventListener('mousedown', (e) => {
  const pos = getPosition(e, canvasEl);

  if (currentTool === 'select') {
    if (canvas.has_selection() && canvas.is_over_selected(pos.x, pos.y)) {
      canvas.start_move(pos.x, pos.y);       // 1. ì„ íƒëœ ê²ƒ ìœ„ â†’ ì´ë™
    } else {
      const hit = canvas.try_select_at(pos.x, pos.y, e.shiftKey);
      if (hit) {
        canvas.start_move(pos.x, pos.y);     // 2. ìŠ¤íŠ¸ë¡œí¬ ìœ„ â†’ ì„ íƒ + ì´ë™ ì¤€ë¹„
      } else {
        canvas.start_rubber_band(pos.x, pos.y); // 3. ë¹ˆ ì˜ì—­ â†’ ëŸ¬ë²„ë°´ë“œ
      }
    }
  } else {
    canvas.start_drawing(pos.x, pos.y);       // 4. íœ/ì§€ìš°ê°œ â†’ ê·¸ë¦¬ê¸°
  }
});
```

í•˜ë‚˜ì˜ ì´ë²¤íŠ¸ì—ì„œ ë„¤ ê°€ì§€ ë¶„ê¸°ê°€ ë‚˜ì˜¨ë‹¤. ì´ê±¸ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•˜ëŠ” í•µì‹¬ì€ **ìƒíƒœ íŒë³„ì„ Rust ìª½ì— ìœ„ì„**í•˜ëŠ” ê²ƒì´ë‹¤. `has_selection()`, `is_over_selected()`, `try_select_at()` ëª¨ë‘ Rustì—ì„œ ê³„ì‚°í•˜ê³  JSëŠ” ê²°ê³¼ì— ë”°ë¼ ë¶„ê¸°ë§Œ í•œë‹¤.

---

## íšŒê³ 

### Retained Modeê°€ ì—´ì–´ì¤€ ê²ƒ

ì´ì „ ê¸€ì—ì„œ "Retained Modeë©´ í™•ì¥ì´ ì‰½ë‹¤"ê³  í–ˆëŠ”ë°, ì‹¤ì œë¡œ í•´ë³´ë‹ˆ ì •ë§ ê·¸ë¬ë‹¤.

| ê¸°ëŠ¥ | êµ¬í˜„ í•µì‹¬ | ë‚œì´ë„ |
|------|----------|--------|
| ì„ íƒ | `HashSet<u32>` + íˆíŠ¸ í…ŒìŠ¤íŠ¸ | íˆíŠ¸ í…ŒìŠ¤íŠ¸ ìˆ˜í•™ì´ ì¢€ í•„ìš” |
| ì´ë™ | `translate(dx, dy)` | ë†€ë¼ìš¸ ì •ë„ë¡œ ë‹¨ìˆœ |
| ë³µì‚¬ | `clone()` | Rustì˜ deriveê°€ ë‹¤ í•´ì¤Œ |
| ë¶™ì—¬ë„£ê¸° | `clone()` + ìƒˆ ID + ì˜¤í”„ì…‹ | ë‹¨ìˆœ |
| ëŸ¬ë²„ë°´ë“œ | AABB êµì°¨ ê²€ì‚¬ | ì¡°ê±´ 4ê°œ |
| ì‚­ì œ | `retain(\|s\| !selected)` | í•œ ì¤„ |

Immediate Modeì˜€ë‹¤ë©´? ì´ë¯¸ ì°íŒ í”½ì…€ì—ì„œ "ì´ê±´ ì–´ë–¤ ìŠ¤íŠ¸ë¡œí¬ì˜ ì¼ë¶€ì¸ê°€?"ë¥¼ ì—­ì¶”ì í•  ë°©ë²•ì´ ì—†ë‹¤. **ë°ì´í„°ë¥¼ ë³´ì¡´í•˜ê³  ìˆì—ˆê¸° ë•Œë¬¸ì—** ì´ ëª¨ë“  ê²Œ ê°€ëŠ¥í–ˆë‹¤.

### ì˜ì™¸ë¡œ ì–´ë ¤ì› ë˜ ê²ƒ: ì´ë²¤íŠ¸ ë¶„ê¸°

ìˆ˜í•™ì´ë‚˜ ë°ì´í„° êµ¬ì¡°ë³´ë‹¤, mousedown í•˜ë‚˜ì—ì„œ "ì´ë™ì¸ê°€ ì„ íƒì¸ê°€ ëŸ¬ë²„ë°´ë“œì¸ê°€"ë¥¼ ì •í™•íˆ íŒë³„í•˜ëŠ” ë¡œì§ì´ ê°€ì¥ ì‹ ê²½ ì“°ì˜€ë‹¤. ìƒíƒœ ë¨¸ì‹ ì´ ë³µì¡í•´ì§ˆìˆ˜ë¡ ì—£ì§€ ì¼€ì´ìŠ¤ê°€ ëŠ˜ì–´ë‚œë‹¤â€”Shift ëˆ„ë¥¸ ì±„ë¡œ ë¹ˆ ì˜ì—­ í´ë¦­, ì„ íƒëœ ìŠ¤íŠ¸ë¡œí¬ ìœ„ì—ì„œ Shift+í´ë¦­, ëŸ¬ë²„ë°´ë“œ ì¤‘ ë§ˆìš°ìŠ¤ê°€ ìº”ë²„ìŠ¤ ë°–ìœ¼ë¡œ ë‚˜ê° ë“±.

ì´ëŸ° ìƒíƒœ ì „ì´ë¥¼ ê¹”ë”í•˜ê²Œ ê´€ë¦¬í•˜ëŠ” ê²Œ ì—ë””í„° ê°œë°œì˜ ì§„ì§œ ì±Œë¦°ì§€ë¼ëŠ” ê±¸ ëŠê¼ˆë‹¤.

### ê·¸ ë‹¤ìŒ: Undo/Redo

ì„ íƒ/ì´ë™/ë³µì‚¬/ì‚­ì œë¥¼ êµ¬í˜„í•˜ê³  ë‚˜ë‹ˆ, Undo/Redoê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ìŒ ê³¼ì œê°€ ëë‹¤. ì»¤ë§¨ë“œ íŒ¨í„´ìœ¼ë¡œ ëª¨ë“  ë™ì‘ì„ ê¸°ë¡í•˜ë©´ ëœë‹¤ëŠ” ê±´ ì•Œê³  ìˆì—ˆëŠ”ë°, ì‹¤ì œë¡œ í•´ë³´ë‹ˆ **ì´ë™ì˜ undoê°€ ì˜ì™¸ë¡œ ê¹Œë‹¤ë¡œì› ë‹¤**.

ë¬¸ì œëŠ” `move_selected`ê°€ ë§¤ `mousemove`ë§ˆë‹¤ í˜¸ì¶œëœë‹¤ëŠ” ê²ƒì´ë‹¤. í”„ë ˆì„ë§ˆë‹¤ `(dx, dy)`ë¥¼ ì ìš©í•˜ë‹ˆê¹Œ, undoí•  "í•˜ë‚˜ì˜ ì´ë™"ì´ ì‹¤ì œë¡œëŠ” ìˆ˜ì‹­~ìˆ˜ë°± ë²ˆì˜ ë¯¸ì„¸ ì´ë™ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆë‹¤. ì´ê±¸ í•´ê²°í•˜ê¸° ìœ„í•´ `start_move`ì—ì„œ `move_total_dx/dy`ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ê³ , ë§¤ í”„ë ˆì„ë§ˆë‹¤ ëˆ„ì í•œ ë’¤, `stop_move`ì—ì„œ ì´ ì´ë™ëŸ‰ì„ í•˜ë‚˜ì˜ `MoveStrokes` ì•¡ì…˜ìœ¼ë¡œ ê¸°ë¡í–ˆë‹¤.

```rust
enum Action {
    AddStroke { stroke: Stroke },
    DeleteStrokes { strokes: Vec<Stroke> },
    MoveStrokes { ids: Vec<u32>, dx: f64, dy: f64 },
    PasteStrokes { strokes: Vec<Stroke> },
    ClearAll { strokes: Vec<Stroke> },
}
```

undoëŠ” ì•¡ì…˜ì„ ì—­ì‹¤í–‰í•˜ê³  redo ìŠ¤íƒìœ¼ë¡œ ì˜®ê¸°ê³ , redoëŠ” ê·¸ ë°˜ëŒ€ë‹¤. ìƒˆë¡œìš´ ì•¡ì…˜ì´ ë°œìƒí•˜ë©´ redo ìŠ¤íƒì„ ë¹„ìš´ë‹¤â€”"ê³¼ê±°ë¥¼ ë°”ê¿¨ìœ¼ë©´ ë¯¸ë˜ëŠ” ì‚¬ë¼ì§„ë‹¤"ëŠ” ì›ì¹™ì´ë‹¤.

### ë‹¤ìŒ ë‹¨ê³„

- **ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°**: `Stroke`ê°€ ì´ë¯¸ `Serialize`ë¥¼ deriveí•˜ê³  ìˆë‹¤
- **ê·¸ë£¹í™”**: ì„ íƒëœ ìŠ¤íŠ¸ë¡œí¬ë¥¼ í•˜ë‚˜ì˜ ê·¸ë£¹ìœ¼ë¡œ ë¬¶ê¸°

ë°ì´í„°ê°€ ìˆìœ¼ë©´, ê°€ëŠ¥ì„±ì€ ëì´ ì—†ë‹¤.
